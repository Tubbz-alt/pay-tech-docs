<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1160px" preserveAspectRatio="none" style="width:1013px;height:1160px;" version="1.1" viewBox="0 0 1013 1160" width="1013px" zoomAndPan="magnify"><defs><filter height="300%" id="f1664d8dr5i9p4" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="111" x2="111" y1="38.2969" y2="1120.3438"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="501" x2="501" y1="38.2969" y2="1120.3438"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="781.5" x2="781.5" y1="38.2969" y2="1120.3438"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="885.5" x2="885.5" y1="38.2969" y2="1120.3438"/><rect fill="#FEFECE" filter="url(#f1664d8dr5i9p4)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="45" x="87" y="3"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="31" x="94" y="22.9951">user</text><rect fill="#FEFECE" filter="url(#f1664d8dr5i9p4)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="45" x="87" y="1119.3438"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="31" x="94" y="1139.3389">user</text><rect fill="#FEFECE" filter="url(#f1664d8dr5i9p4)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="451" y="3"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="83" x="458" y="22.9951">your service</text><rect fill="#FEFECE" filter="url(#f1664d8dr5i9p4)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="451" y="1119.3438"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="83" x="458" y="1139.3389">your service</text><rect fill="#FEFECE" filter="url(#f1664d8dr5i9p4)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="84" x="737.5" y="3"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="70" x="744.5" y="22.9951">data store</text><rect fill="#FEFECE" filter="url(#f1664d8dr5i9p4)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="84" x="737.5" y="1119.3438"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="70" x="744.5" y="1139.3389">data store</text><rect fill="#FEFECE" filter="url(#f1664d8dr5i9p4)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="96" x="835.5" y="3"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="82" x="842.5" y="22.9951">GOV.UK Pay</text><rect fill="#FEFECE" filter="url(#f1664d8dr5i9p4)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="96" x="835.5" y="1119.3438"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="82" x="842.5" y="1139.3389">GOV.UK Pay</text><polygon fill="#A80036" points="489.5,65.4297,499.5,69.4297,489.5,73.4297,493.5,69.4297" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="111.5" x2="495.5" y1="69.4297" y2="69.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="74" x="118.5" y="64.3638">visit service</text><path d="M20,82.4297 L20,107.4297 L199,107.4297 L199,92.4297 L189,82.4297 L20,82.4297 " fill="#FBFB77" filter="url(#f1664d8dr5i9p4)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M189,82.4297 L189,92.4297 L199,92.4297 L189,82.4297 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="158" x="26" y="99.4966">click "Buy fishing license"</text><polygon fill="#A80036" points="489.5,133.6953,499.5,137.6953,489.5,141.6953,493.5,137.6953" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="111.5" x2="495.5" y1="137.6953" y2="137.6953"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="65" x="118.5" y="132.6294">POST /buy</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="501.5" x2="543.5" y1="166.8281" y2="166.8281"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="543.5" x2="543.5" y1="166.8281" y2="179.8281"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="502.5" x2="543.5" y1="179.8281" y2="179.8281"/><polygon fill="#A80036" points="512.5,175.8281,502.5,179.8281,512.5,183.8281,508.5,179.8281" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="82" x="508.5" y="161.7622">start session</text><path d="M423,192.8281 L423,232.8281 L575,232.8281 L575,202.8281 L565,192.8281 L423,192.8281 " fill="#FBFB77" filter="url(#f1664d8dr5i9p4)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M565,192.8281 L565,202.8281 L575,202.8281 L565,192.8281 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="103" x="429" y="209.895">call GOV.UK Pay</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="131" x="429" y="225.0278">to create a payment</text><polygon fill="#A80036" points="873.5,334.8906,883.5,338.8906,873.5,342.8906,877.5,338.8906" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="501.5" x2="879.5" y1="338.8906" y2="338.8906"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="137" x="508.5" y="258.1606">POST /v1/payments {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="74" x="516.5" y="273.2935">description,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="54" x="516.5" y="288.4263">amount,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="62" x="516.5" y="303.5591">return_url</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="516.5" y="318.6919">reference</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="508.5" y="333.8247">}</text><polygon fill="#A80036" points="512.5,364.0234,502.5,368.0234,512.5,372.0234,508.5,368.0234" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="506.5" x2="884.5" y1="368.0234" y2="368.0234"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="281" x="518.5" y="362.9575">201 CREATED {... payment_id: next_url: ... }</text><path d="M312,381.0234 L312,406.0234 L687,406.0234 L687,391.0234 L677,381.0234 L312,381.0234 " fill="#FBFB77" filter="url(#f1664d8dr5i9p4)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M677,381.0234 L677,391.0234 L687,391.0234 L677,381.0234 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="354" x="318" y="398.0903">extract the payment_id and next_url from the response</text><polygon fill="#A80036" points="769.5,447.4219,779.5,451.4219,769.5,455.4219,773.5,451.4219" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="501.5" x2="775.5" y1="451.4219" y2="451.4219"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="508.5" y="431.2231">store payment_id in</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="508.5" y="446.356">list of incomplete journeys</text><polygon fill="#A80036" points="512.5,476.5547,502.5,480.5547,512.5,484.5547,508.5,480.5547" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="506.5" x2="780.5" y1="480.5547" y2="480.5547"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="65" x="518.5" y="475.4888">journey_id</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="501.5" x2="543.5" y1="509.6875" y2="509.6875"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="543.5" x2="543.5" y1="509.6875" y2="522.6875"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="502.5" x2="543.5" y1="522.6875" y2="522.6875"/><polygon fill="#A80036" points="512.5,518.6875,502.5,522.6875,512.5,526.6875,508.5,522.6875" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="209" x="508.5" y="504.6216">record journey_id in user session</text><polygon fill="#A80036" points="122.5,547.8203,112.5,551.8203,122.5,555.8203,118.5,551.8203" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="116.5" x2="500.5" y1="551.8203" y2="551.8203"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="366" x="128.5" y="546.7544">302 redirect to next_url (http header sets session cookie)</text><path d="M8,564.8203 L8,604.8203 L211,604.8203 L211,574.8203 L201,564.8203 L8,564.8203 " fill="#FBFB77" filter="url(#f1664d8dr5i9p4)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M201,564.8203 L201,574.8203 L211,574.8203 L201,564.8203 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="182" x="14" y="581.8872">user's browser automatically</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="120" x="14" y="597.02">follows the redirect</text><polygon fill="#A80036" points="873.5,631.2188,883.5,635.2188,873.5,639.2188,877.5,635.2188" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="111.5" x2="879.5" y1="635.2188" y2="635.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="118.5" y="630.1528">enter card details</text><polygon fill="#A80036" points="873.5,660.3516,883.5,664.3516,873.5,668.3516,877.5,664.3516" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="111.5" x2="879.5" y1="664.3516" y2="664.3516"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="109" x="118.5" y="659.2856">confirm payment</text><path d="M765,677.3516 L765,732.3516 L1001,732.3516 L1001,687.3516 L991,677.3516 L765,677.3516 " fill="#FBFB77" filter="url(#f1664d8dr5i9p4)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M991,677.3516 L991,687.3516 L1001,687.3516 L991,677.3516 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="771" y="694.4185">when the user has finished,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="184" x="771" y="709.5513">we redirect them back to the</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="215" x="771" y="724.6841">return_url specified by the service</text><polygon fill="#A80036" points="122.5,758.8828,112.5,762.8828,122.5,766.8828,118.5,762.8828" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="116.5" x2="884.5" y1="762.8828" y2="762.8828"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="132" x="128.5" y="757.8169">redirect to return_url</text><path d="M17,775.8828 L17,815.8828 L202,815.8828 L202,785.8828 L192,775.8828 L17,775.8828 " fill="#FBFB77" filter="url(#f1664d8dr5i9p4)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M192,775.8828 L192,785.8828 L202,785.8828 L192,775.8828 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="164" x="23" y="792.9497">the user's browser will still</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="153" x="23" y="808.0825">have the session cookie</text><polygon fill="#A80036" points="489.5,842.2813,499.5,846.2813,489.5,850.2813,493.5,846.2813" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="111.5" x2="495.5" y1="846.2813" y2="846.2813"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="227" x="118.5" y="841.2153">GET return_url (with session cookie)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="501.5" x2="543.5" y1="875.4141" y2="875.4141"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="543.5" x2="543.5" y1="875.4141" y2="888.4141"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="502.5" x2="543.5" y1="888.4141" y2="888.4141"/><polygon fill="#A80036" points="512.5,884.4141,502.5,888.4141,512.5,892.4141,508.5,888.4141" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="232" x="508.5" y="870.3481">extract journey_id from user session</text><polygon fill="#A80036" points="769.5,913.5469,779.5,917.5469,769.5,921.5469,773.5,917.5469" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="501.5" x2="775.5" y1="917.5469" y2="917.5469"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="256" x="508.5" y="912.481">find incomplete journey using journey_id</text><polygon fill="#A80036" points="512.5,942.6797,502.5,946.6797,512.5,950.6797,508.5,946.6797" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="506.5" x2="780.5" y1="946.6797" y2="946.6797"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="75" x="518.5" y="941.6138">payment_id</text><path d="M320,959.6797 L320,984.6797 L678,984.6797 L678,969.6797 L668,959.6797 L320,959.6797 " fill="#FBFB77" filter="url(#f1664d8dr5i9p4)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M668,959.6797 L668,969.6797 L678,969.6797 L668,959.6797 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="337" x="326" y="976.7466">Call GOV.UK Pay to enquire about payment outcome</text><polygon fill="#A80036" points="873.5,1010.9453,883.5,1014.9453,873.5,1018.9453,877.5,1014.9453" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="501.5" x2="879.5" y1="1014.9453" y2="1014.9453"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="217" x="508.5" y="1009.8794">GET /v1/payments/&lt;payment_id&gt;</text><polygon fill="#A80036" points="512.5,1040.0781,502.5,1044.0781,512.5,1048.0781,508.5,1044.0781" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="506.5" x2="884.5" y1="1044.0781" y2="1044.0781"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="207" x="518.5" y="1039.0122">200 OK {status: SUCCESS/FAIL}</text><polygon fill="#A80036" points="769.5,1069.2109,779.5,1073.2109,769.5,1077.2109,773.5,1073.2109" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="501.5" x2="775.5" y1="1073.2109" y2="1073.2109"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="185" x="508.5" y="1068.145">mark journey_id as complete</text><polygon fill="#A80036" points="122.5,1098.3438,112.5,1102.3438,122.5,1106.3438,118.5,1102.3438" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="116.5" x2="500.5" y1="1102.3438" y2="1102.3438"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="262" x="128.5" y="1097.2778">display confirmation screen (success/fail)</text><!--
@startuml
participant user
participant "your service" as service
participant "data store" as db
participant "GOV.UK Pay" as pay

user->service: visit service
note over user: click "Buy fishing license"
user->service: POST /buy
service->service: start session
note over service: call GOV.UK Pay\nto create a payment
service -> pay: POST /v1/payments {\n  description,\n  amount,\n  return_url\n  reference\n}
pay - -> service: 201 CREATED {... payment_id: next_url: ... }
note over service: extract the payment_id and next_url from the response
service->db: store payment_id in\nlist of incomplete journeys
db- ->service: journey_id
service->service: record journey_id in user session
service- ->user: 302 redirect to next_url (http header sets session cookie)
note over user: user's browser automatically\nfollows the redirect
user->pay: enter card details
user->pay: confirm payment
note over pay: when the user has finished,\nwe redirect them back to the\nreturn_url specified by the service
pay- ->user: redirect to return_url
note over user: the user's browser will still\nhave the session cookie
user->service: GET return_url (with session cookie)
service->service: extract journey_id from user session
service->db: find incomplete journey using journey_id
db- ->service: payment_id
note over service: Call GOV.UK Pay to enquire about payment outcome
service->pay: GET /v1/payments/<payment_id>
pay- ->service: 200 OK {status: SUCCESS/FAIL}
service->db: mark journey_id as complete
service->user: display confirmation screen (success/fail)
@enduml

PlantUML version 1.2018.14beta6(Unknown compile time)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.7.0_25-b15
Operating System: Linux
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>